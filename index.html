import React, { useEffect, useMemo, useState } from "react";

// ===== Utilidad para contraste de color (para el logo) =====
function contrastColor(hex = "#2563eb") {
  let c = hex.replace("#", "");
  if (c.length === 3) c = c.split("").map((ch) => ch + ch).join("");
  const r = parseInt(c.slice(0, 2), 16);
  const g = parseInt(c.slice(2, 4), 16);
  const b = parseInt(c.slice(4, 6), 16);
  const yiq = (r * 299 + g * 587 + b * 114) / 1000;
  return yiq >= 140 ? "#111827" : "#ffffff";
}

// ===== Logo: Escudo + Beaker + Check (SVG) =====
function LogoBeakerShield({ initials = "LC", color = "#2563eb", size = 36 }: { initials?: string; color?: string; size?: number }) {
  const text = contrastColor(color);
  const id = useMemo(() => `grad-${Math.random().toString(36).slice(2)}`,[color]);
  return (
    <div className="flex items-center gap-2">
      <svg width={size} height={size} viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-label="Logo Escudo Beaker">
        <defs>
          <linearGradient id={id} x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stopColor={color} stopOpacity="1" />
            <stop offset="100%" stopColor={color} stopOpacity="0.75" />
          </linearGradient>
        </defs>
        {/* Escudo */}
        <path d="M8 10c10 4 20 4 24 4s14 0 24-4v22c0 12-11 20-24 24C21 52 8 44 8 32Z" fill={`url(#${id})`} stroke={color} strokeWidth="2" />
        {/* Beaker */}
        <path d="M24 16h16m-4 0v10l6 14c1 4-2 8-6 8h-8c-4 0-7-4-6-8l6-14V16" fill="none" stroke={text} strokeWidth="2.4" strokeLinecap="round" />
        <path d="M26 40c6 2 12 2 16 0" stroke={text} strokeWidth="2" opacity=".35" />
        {/* Check */}
        <path d="M26 31l4 4 10-10" stroke={text} strokeWidth="3" strokeLinecap="round" fill="none" />
      </svg>
      <span className="font-bold text-sm" style={{ color }}>{initials}</span>
    </div>
  );
}

// ----- Tipos -----
type ChecklistItem = {
  id: string;
  label: string;
  ref?: string;
  notes?: string;
  maxScore?: number;
  score?: number;
  dueDate?: string;
  priority?: "alta" | "media" | "baja";
  category?: string;
};

type Section = {
  id: string;
  title: string;
  items: ChecklistItem[];
};

type Status = "total" | "proceso" | "pendiente"; // total = Cumplimiento total; proceso = En proceso

const STORAGE_KEY = "labComplianceApp_v4"; // nueva versión con sistema de evaluación

// Utilidad para crear IDs a partir del texto
const slug = (s: string) =>
  s
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");

// ----- Descripciones normativas (del documento proporcionado) -----
const DESCS: Record<string, string> = {
  // ... (mantener todas las descripciones existentes)
  "manual-organizacion": `¿Qué es? Define la estructura y filosofía del laboratorio.\nContenido mínimo: índice; introducción; misión y visión; organigrama con líneas de autoridad; objetivo del manual; **descripción de puestos y funciones** (p. ej. Responsable Sanitario, Químico Analista, Técnico, Recepción); perfiles y requisitos; firmas.\nEvidencia de cumplimiento: organigrama vigente, descripciones firmadas, actualización controlada de versión.`,
  // ... (todas las demás descripciones)
};

// ===== SISTEMA DE EVALUACIÓN Y CALIFICACIÓN =====
type EvaluationCriteria = {
  id: string;
  label: string;
  maxScore: number;
};

type EvaluationModalProps = {
  item: ChecklistItem;
  isOpen: boolean;
  onClose: () => void;
  onSave: (score: number, notes: string, status: Status) => void;
};

// Modal de evaluación con criterios detallados
function EvaluationModal({ item, isOpen, onClose, onSave }: EvaluationModalProps) {
  const [score, setScore] = useState(item.score || 0);
  const [notes, setNotes] = useState(item.notes || "");
  const [status, setStatus] = useState<Status>(item.score === (item.maxScore || 10) ? "total" : item.score && item.score > 0 ? "proceso" : "pendiente");

  const maxScore = item.maxScore || 10;
  const criteria: EvaluationCriteria[] = [
    { id: "documentacion", label: "Documentación completa", maxScore: 3 },
    { id: "implementacion", label: "Implementación efectiva", maxScore: 4 },
    { id: "evidencias", label: "Evidencias disponibles", maxScore: 3 }
  ];

  const handleSave = () => {
    onSave(score, notes, status);
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-white rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-bold">Evaluar: {item.label}</h3>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">✕</button>
        </div>

        <div className="mb-6 p-4 bg-blue-50 rounded-lg">
          <h4 className="font-semibold mb-2">Descripción del requerimiento:</h4>
          <p className="text-sm text-gray-700 whitespace-pre-wrap">
            {DESCS[item.id] || "Guía: especifica propósito, contenido mínimo y evidencia esperada."}
          </p>
        </div>

        {/* Criterios de evaluación */}
        <div className="mb-6">
          <h4 className="font-semibold mb-3">Criterios de Evaluación:</h4>
          {criteria.map((criterion) => (
            <div key={criterion.id} className="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded-lg">
              <span className="text-sm">{criterion.label}</span>
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  min="0"
                  max={criterion.maxScore}
                  className="w-16 p-1 border rounded text-center"
                  placeholder="0"
                  onChange={(e) => {
                    const value = parseInt(e.target.value) || 0;
                    const newScore = criteria.reduce((acc, curr, idx) => 
                      acc + (curr.id === criterion.id ? Math.min(value, curr.maxScore) : 0), 0);
                    setScore(Math.min(newScore, maxScore));
                  }}
                />
                <span className="text-xs text-gray-500">/ {criterion.maxScore}</span>
              </div>
            </div>
          ))}
        </div>

        {/* Score total */}
        <div className="mb-4 p-4 bg-yellow-50 rounded-lg">
          <div className="flex justify-between items-center">
            <span className="font-semibold">Puntuación Total:</span>
            <div className="flex items-center gap-2">
              <span className="text-2xl font-bold">{score}</span>
              <span className="text-gray-500">/ {maxScore}</span>
            </div>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div 
              className="bg-green-600 h-2 rounded-full transition-all duration-300"
              style={{ width: `${(score / maxScore) * 100}%` }}
            ></div>
          </div>
        </div>

        {/* Estado del item */}
        <div className="mb-4">
          <label className="block text-sm font-medium mb-2">Estado de Cumplimiento:</label>
          <div className="flex gap-2">
            <button
              onClick={() => setStatus("total")}
              className={`flex-1 py-2 px-3 rounded-lg border transition ${
                status === "total"
                  ? "bg-green-600 border-green-600 text-white"
                  : "bg-white border-gray-300 text-green-700 hover:bg-green-50"
              }`}
            >
              Cumplimiento Total
            </button>
            <button
              onClick={() => setStatus("proceso")}
              className={`flex-1 py-2 px-3 rounded-lg border transition ${
                status === "proceso"
                  ? "bg-yellow-500 border-yellow-500 text-white"
                  : "bg-white border-gray-300 text-yellow-700 hover:bg-yellow-50"
              }`}
            >
              En Proceso
            </button>
            <button
              onClick={() => setStatus("pendiente")}
              className={`flex-1 py-2 px-3 rounded-lg border transition ${
                status === "pendiente"
                  ? "bg-red-500 border-red-500 text-white"
                  : "bg-white border-gray-300 text-red-700 hover:bg-red-50"
              }`}
            >
              Pendiente
            </button>
          </div>
        </div>

        {/* Notas */}
        <div className="mb-6">
          <label className="block text-sm font-medium mb-2">Observaciones y Evidencias:</label>
          <textarea
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
            placeholder="Registre observaciones, evidencias encontradas, planes de acción..."
            className="w-full rounded-lg border p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            rows={4}
          />
        </div>

        {/* Acciones */}
        <div className="flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 py-3 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50"
          >
            Cancelar
          </button>
          <button
            onClick={handleSave}
            className="flex-1 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700"
          >
            Guardar Evaluación
          </button>
        </div>
      </div>
    </div>
  );
}

// ===== COMPONENTE PRINCIPAL MEJORADO =====
export default function LabComplianceDashboard() {
  const [sections, setSections] = useState<Section[]>(initialSections);
  const [status, setStatus] = useState<Record<string, Status | undefined>>({});
  const [createdAt, setCreatedAt] = useState<Record<string, string>>({});
  const [notes, setNotes] = useState<Record<string, string>>({});
  const [scores, setScores] = useState<Record<string, number>>({});
  const [query, setQuery] = useState("");
  const [showOnlyPending, setShowOnlyPending] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [evaluationModal, setEvaluationModal] = useState<{isOpen: boolean; item: ChecklistItem | null}>({isOpen: false, item: null});

  // Self-tests
  useEffect(() => {
    try {
      const items = sections.flatMap((s) => s.items.map((it) => it.id));
      console.assert(items.length > 0, "[TEST] Debe haber ítems definidos");
      console.info("[TEST] Autoverificación terminada.");
    } catch (err) {
      console.error("[TEST] Error en self-tests:", err);
    }
  }, [sections]);

  // Cargar del almacenamiento local
  useEffect(() => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed.sections) setSections(parsed.sections);
        if (parsed.status) setStatus(parsed.status);
        if (parsed.createdAt) setCreatedAt(parsed.createdAt);
        if (parsed.notes) setNotes(parsed.notes);
        if (parsed.scores) setScores(parsed.scores);
      }
    } catch {}
  }, []);

  // Guardar en almacenamiento local
  useEffect(() => {
    const payload = { sections, status, createdAt, notes, scores };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }, [sections, status, createdAt, notes, scores]);

  // Lista plana de todos los ítems
  const allItems = useMemo(
    () =>
      sections.flatMap((sec) =>
        sec.items.map((it) => ({ 
          ...it, 
          sectionId: sec.id, 
          sectionTitle: sec.title,
          score: scores[it.id] || 0,
          maxScore: it.maxScore || 10,
          status: status[it.id] || 'pendiente'
        }))
      ),
    [sections, scores, status]
  );

  // Filtro por búsqueda y pendientes
  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    return allItems.filter((it) => {
      if (showOnlyPending && status[it.id] === "total") return false;
      if (!q) return true;
      return (
        it.label.toLowerCase().includes(q) ||
        (it.ref || "").toLowerCase().includes(q) ||
        (it.sectionTitle || "").toLowerCase().includes(q)
      );
    });
  }, [allItems, status, query, showOnlyPending]);

  // Cálculos de progreso MEJORADOS
  const totals = useMemo(() => {
    const total = allItems.length;
    const done = allItems.reduce((acc, it) => acc + (status[it.id] === "total" ? 1 : 0), 0);
    const inProgress = allItems.reduce((acc, it) => acc + (status[it.id] === "proceso" ? 1 : 0), 0);
    const pending = allItems.reduce((acc, it) => acc + (!status[it.id] || status[it.id] === "pendiente" ? 1 : 0), 0);
    
    // Calificación promedio basada en scores
    const totalScore = allItems.reduce((acc, it) => acc + (scores[it.id] || 0), 0);
    const maxPossibleScore = allItems.reduce((acc, it) => acc + (it.maxScore || 10), 0);
    const averageScore = maxPossibleScore > 0 ? Math.round((totalScore / maxPossibleScore) * 100) : 0;
    
    // Items críticos (score bajo)
    const criticalItems = allItems.filter(it => {
      const score = scores[it.id] || 0;
      const maxScore = it.maxScore || 10;
      return score < maxScore * 0.5 && status[it.id] !== "total";
    }).length;

    const pct = total ? Math.round((done / total) * 100) : 0;
    
    return { total, done, inProgress, pending, pct, averageScore, criticalItems, totalScore, maxPossibleScore };
  }, [allItems, status, scores]);

  // Acciones MEJORADAS
  const setItemStatus = (id: string, value: Status) => {
    setStatus((prev) => ({ ...prev, [id]: value }));
    setCreatedAt((prev) => ({ ...prev, [id]: prev[id] || new Date().toISOString().slice(0, 10) }));
  };

  const setItemScore = (id: string, score: number) => {
    setScores(prev => ({ ...prev, [id]: score }));
    // Actualizar estado automáticamente basado en el score
    const maxScore = allItems.find(it => it.id === id)?.maxScore || 10;
    if (score === maxScore) {
      setStatus(prev => ({ ...prev, [id]: "total" }));
    } else if (score > 0) {
      setStatus(prev => ({ ...prev, [id]: "proceso" }));
    } else {
      setStatus(prev => ({ ...prev, [id]: "pendiente" }));
    }
  };

  const setItemDate = (id: string, value: string) => {
    setCreatedAt((prev) => ({ ...prev, [id]: value }));
  };

  const setItemNote = (id: string, value: string) => {
    setNotes((prev) => ({ ...prev, [id]: value }));
  };

  const handleEvaluate = (item: ChecklistItem) => {
    setEvaluationModal({ isOpen: true, item });
  };

  const handleSaveEvaluation = (itemId: string, score: number, notes: string, status: Status) => {
    setItemScore(itemId, score);
    setItemNote(itemId, notes);
    setItemStatus(itemId, status);
  };

  const addCustomItem = (sectionId: string) => {
    const label = prompt("Describe el nuevo punto de verificación (ítem)");
    if (!label) return;
    setSections((prev) =>
      prev.map((s) => {
        if (s.id !== sectionId) return s;
        const id = slug(`${sectionId}-${label}`).slice(0, 64);
        return { ...s, items: [...s.items, { id, label, maxScore: 10 }] };
      })
    );
  };

  const exportJSON = () => {
    const payload = { 
      sections, 
      status, 
      createdAt, 
      notes, 
      scores,
      totals,
      exportedAt: new Date().toISOString() 
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `cumplimiento-lab-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const importJSON = (file: File) => {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(String(reader.result || "{}"));
        if (parsed.sections) setSections(parsed.sections);
        if (parsed.status) setStatus(parsed.status);
        if (parsed.createdAt) setCreatedAt(parsed.createdAt);
        if (parsed.notes) setNotes(parsed.notes);
        if (parsed.scores) setScores(parsed.scores);
        alert("Datos importados correctamente.");
      } catch (e) {
        alert("Archivo no válido.");
      }
    };
    reader.readAsText(file);
  };

  const resetAll = () => {
    if (!confirm("¿Restablecer todo a valores iniciales? Esto borrará tu progreso.")) return;
    setSections(initialSections);
    setStatus({});
    setCreatedAt({});
    setNotes({});
    setScores({});
    localStorage.removeItem(STORAGE_KEY);
  };

  // Render de un ítem MEJORADO
  const ItemRow: React.FC<{ it: ChecklistItem & { sectionId: string; sectionTitle: string; score: number; maxScore: number; status: Status } }> = ({ it }) => {
    const st = status[it.id] || 'pendiente';
    const dt = createdAt[it.id] || "";
    const n = notes[it.id] || "";
    const score = scores[it.id] || 0;
    const [openNote, setOpenNote] = useState(false);
    const [openInfo, setOpenInfo] = useState(false);

    const scorePercentage = (score / it.maxScore) * 100;
    const scoreColor = scorePercentage >= 80 ? 'bg-green-500' : 
                      scorePercentage >= 50 ? 'bg-yellow-500' : 'bg-red-500';

    return (
      <div className={`w-full rounded-xl border p-3 mb-2 bg-white/80 shadow-sm ${st === "total" ? "opacity-85" : ""}`}>
        <div className="flex items-start gap-3">
          {/* Indicador circular con score */}
          <div className="relative mt-1.5">
            <div className={`h-4 w-4 rounded-full border ${st === "total" ? "bg-green-600 border-green-600" : st === "proceso" ? "bg-yellow-400 border-yellow-400" : "bg-gray-300 border-gray-300"}`} />
            {score > 0 && (
              <div className="absolute -top-1 -right-1 bg-blue-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                {score}
              </div>
            )}
          </div>
          
          <div className="flex-1">
            <div className="text-sm md:text-base font-medium text-gray-900">{it.label}</div>
            {it.ref && <div className="text-xs text-gray-500 mt-0.5">{it.ref}</div>}

            {/* Barra de progreso del score */}
            {score > 0 && (
              <div className="mt-2">
                <div className="flex justify-between text-xs mb-1">
                  <span>Progreso: {score}/{it.maxScore}</span>
                  <span>{Math.round(scorePercentage)}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className={`h-2 rounded-full ${scoreColor} transition-all duration-300`}
                    style={{ width: `${scorePercentage}%` }}
                  ></div>
                </div>
              </div>
            )}

            {/* Botón de ayuda */}
            <div className="mt-2">
              <button
                onClick={() => setOpenInfo((v) => !v)}
                className="text-xs px-2 py-1 rounded-lg bg-white border hover:bg-blue-50"
              >
                {openInfo ? "Ocultar: ¿Qué significa?" : "¿Qué significa y cómo cumplir?"}
              </button>
            </div>
            {openInfo && (
              <div className="mt-2 text-xs leading-5 bg-blue-50/60 border border-blue-100 rounded-lg p-2 whitespace-pre-wrap">
                {DESCS[it.id] || "Guía: especifica propósito, contenido mínimo y evidencia esperada."}
              </div>
            )}

            {/* Botones de acción MEJORADOS */}
            <div className="flex items-center gap-2 mt-3 flex-wrap">
              <button
                onClick={() => handleEvaluate(it)}
                className="text-xs px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"
              >
                📋 Evaluar
              </button>
              <button
                onClick={() => setItemStatus(it.id, "total")}
                className={`text-xs px-3 py-2 rounded-lg border transition ${
                  st === "total"
                    ? "bg-green-600 border-green-600 text-white"
                    : "bg-white border-gray-300 text-green-700 hover:bg-green-50"
                }`}
              >
                Cumplimiento total
              </button>
              <button
                onClick={() => setItemStatus(it.id, "proceso")}
                className={`text-xs px-3 py-2 rounded-lg border transition ${
                  st === "proceso"
                    ? "bg-yellow-500 border-yellow-500 text-white"
                    : "bg-white border-gray-300 text-yellow-700 hover:bg-yellow-50"
                }`}
              >
                En proceso
              </button>
            </div>

            {/* Fecha y notas */}
            <div className="mt-3 grid grid-cols-1 gap-2">
              <div className="flex items-center gap-2">
                <label className="text-xs text-gray-600">Fecha evaluación:</label>
                <input
                  type="date"
                  value={dt}
                  onChange={(e) => setItemDate(it.id, e.target.value)}
                  className="rounded-lg border p-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
                <button
                  onClick={() => setItemDate(it.id, new Date().toISOString().slice(0, 10))}
                  className="text-xs px-2 py-1 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100"
                >
                  Hoy
                </button>
              </div>

              <button
                onClick={() => setOpenNote((v) => !v)}
                className="text-xs px-2 py-1 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 w-fit"
              >
                {openNote ? "Ocultar nota" : n ? "Editar nota" : "Añadir nota"}
              </button>
              
              {openNote && (
                <textarea
                  value={n}
                  onChange={(e) => setItemNote(it.id, e.target.value)}
                  placeholder="Observaciones, evidencia, plan de acción…"
                  className="w-full rounded-lg border p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                  rows={3}
                />
              )}
            </div>
          </div>
        </div>
      </div>
    );
  };

  // Agrupa ítems filtrados por sección
  const grouped = useMemo(() => {
    const bySection: Record<string, { section: Section; items: any[] }> = {};
    for (const s of sections) bySection[s.id] = { section: s, items: [] };
    for (const it of filtered) (bySection as any)[(it as any).sectionId].items.push(it);
    return Object.values(bySection).filter((g) => g.items.length > 0);
  }, [sections, filtered]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-blue-100 text-gray-900">
      {/* Topbar */}
      <header className="sticky top-0 z-40 backdrop-blur bg-white/70 border-b">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
          <button
            onClick={() => setSidebarOpen(true)}
            className="md:hidden h-10 w-10 rounded-xl border flex items-center justify-center bg-white"
            aria-label="Abrir menú"
          >
            <span className="i">☰</span>
          </button>
          <div className="flex items-center gap-2">
            <LogoBeakerShield initials="LC" color="#2563eb" size={36} />
            <div>
              <div className="font-semibold leading-4">Cumplimiento de Laboratorio</div>
              <div className="text-xs text-gray-600">Sistema de Evaluación Completo</div>
            </div>
          </div>
          <div className="ml-auto hidden md:flex items-center gap-2">
            <button onClick={() => window.print()} className="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm shadow hover:bg-blue-700">Exportar PDF</button>
            <button onClick={exportJSON} className="px-3 py-2 rounded-xl bg-white border text-sm hover:bg-gray-50">Exportar JSON</button>
            <label className="px-3 py-2 rounded-xl bg-white border text-sm hover:bg-gray-50 cursor-pointer">
              Importar JSON
              <input type="file" accept="application/json" className="hidden" onChange={(e) => e.target.files && importJSON(e.target.files[0])} />
            </label>
            <button onClick={resetAll} className="px-3 py-2 rounded-xl bg-white border text-sm hover:bg-gray-50">Restablecer</button>
          </div>
        </div>
      </header>

      {/* Contenido */}
      <div className="max-w-6xl mx-auto px-4 py-4 md:py-6 grid md:grid-cols-[300px_1fr] gap-4">
        {/* Sidebar (desktop) MEJORADO */}
        <aside className="hidden md:block sticky top-[64px] h-[calc(100vh-80px)] overflow-auto p-2 rounded-2xl border bg-white/70">
          <Sidebar sections={sections} totals={totals} onAddItem={addCustomItem} />
        </aside>

        {/* Panel principal */}
        <main>
          {/* Controles rápidos MEJORADOS */}
          <div className="mb-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <div className="rounded-2xl border bg-white/70 p-4">
              <div className="text-xs text-gray-500">Cumplimiento Total</div>
              <div className="mt-2 flex items-center gap-3">
                <div className="relative h-14 w-14">
                  <div
                    className="absolute inset-0 rounded-full"
                    style={{
                      background: `conic-gradient(#2563eb ${totals.pct * 3.6}deg, #e5e7eb 0deg)`,
                    }}
                  />
                  <div className="absolute inset-1 rounded-full bg-white grid place-items-center text-sm font-semibold">
                    {totals.pct}%
                  </div>
                </div>
                <div>
                  <div className="text-sm font-semibold">{totals.done} / {totals.total} ítems</div>
                  <div className="text-xs text-gray-500">Completados</div>
                </div>
              </div>
            </div>

            <div className="rounded-2xl border bg-white/70 p-4">
              <div className="text-xs text-gray-500">Calificación Promedio</div>
              <div className="mt-2 flex items-center gap-3">
                <div className="relative h-14 w-14">
                  <div
                    className="absolute inset-0 rounded-full"
                    style={{
                      background: `conic-gradient(#10b981 ${totals.averageScore * 3.6}deg, #e5e7eb 0deg)`,
                    }}
                  />
                  <div className="absolute inset-1 rounded-full bg-white grid place-items-center text-sm font-semibold">
                    {totals.averageScore}%
                  </div>
                </div>
                <div>
                  <div className="text-sm font-semibold">{totals.totalScore} / {totals.maxPossibleScore} pts</div>
                  <div className="text-xs text-gray-500">Puntuación total</div>
                </div>
              </div>
            </div>

            <div className="rounded-2xl border bg-white/70 p-4">
              <div className="text-xs text-gray-500">Estado General</div>
              <div className="mt-2 space-y-1">
                <div className="flex justify-between text-sm">
                  <span className="text-green-600">✓ Completados:</span>
                  <span>{totals.done}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-yellow-600">🔄 En proceso:</span>
                  <span>{totals.inProgress}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-red-600">⏳ Pendientes:</span>
                  <span>{totals.pending}</span>
                </div>
              </div>
            </div>

            <div className="rounded-2xl border bg-white/70 p-4">
              <div className="text-xs text-gray-500">Búsqueda y Filtros</div>
              <input
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="Buscar ítems..."
                className="mt-2 w-full rounded-xl border p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <div className="mt-2 flex items-center justify-between">
                <div className="text-sm">Solo pendientes</div>
                <button
                  onClick={() => setShowOnlyPending((v) => !v)}
                  className={`h-7 w-12 rounded-full relative transition ${
                    showOnlyPending ? "bg-blue-600" : "bg-gray-300"
                  }`}
                >
                  <span
                    className={`absolute top-0.5 h-6 w-6 rounded-full bg-white shadow transition ${
                      showOnlyPending ? "right-0.5" : "left-0.5"
                    }`}
                  />
                </button>
              </div>
            </div>
          </div>

          {/* Listado agrupado */}
          {grouped.map(({ section, items }) => (
            <section id={section.id} key={section.id} className="mb-6">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-bold text-blue-800">{section.title}</h2>
                <button
                  onClick={() => addCustomItem(section.id)}
                  className="text-xs px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100"
                >
                  + Añadir ítem
                </button>
              </div>
              <div>
                {items.map((it) => (
                  <ItemRow key={it.id} it={it} />
                ))}
              </div>
            </section>
          ))}

          {/* Acciones inferiores (móvil) */}
          <div className="md:hidden mt-6 grid grid-cols-2 gap-2">
            <button onClick={() => window.print()} className="px-3 py-3 rounded-2xl bg-blue-600 text-white text-sm shadow">Exportar PDF</button>
            <button onClick={exportJSON} className="px-3 py-3 rounded-2xl bg-white border text-sm">Exportar JSON</button>
            <label className="col-span-2 px-3 py-3 rounded-2xl bg-white border text-sm text-center cursor-pointer">
              Importar JSON
              <input type="file" accept="application/json" className="hidden" onChange={(e) => e.target.files && importJSON(e.target.files[0])} />
            </label>
            <button onClick={resetAll} className="col-span-2 px-3 py-3 rounded-2xl bg-white border text-sm">Restablecer</button>
          </div>
        </main>
      </div>

      {/* Modal de evaluación */}
      {evaluationModal.isOpen && evaluationModal.item && (
        <EvaluationModal
          item={evaluationModal.item}
          isOpen={evaluationModal.isOpen}
          onClose={() => setEvaluationModal({ isOpen: false, item: null })}
          onSave={(score, notes, status) => handleSaveEvaluation(evaluationModal.item!.id, score, notes, status)}
        />
      )}

      {/* Sidebar móvil */}
      {sidebarOpen && (
        <div className="fixed inset-0 z-50 md:hidden" aria-modal="true" role="dialog">
          <div className="absolute inset-0 bg-black/40" onClick={() => setSidebarOpen(false)} />
          <div className="absolute left-0 top-0 h-full w-[85%] max-w-xs bg-white p-3 shadow-2xl">
            <div className="flex items-center justify-between mb-2">
              <div className="font-semibold">Menú</div>
              <button onClick={() => setSidebarOpen(false)} className="h-9 w-9 rounded-lg border">✕</button>
            </div>
            <Sidebar sections={sections} totals={totals} onAddItem={addCustomItem} onNavigate={() => setSidebarOpen(false)} />
          </div>
        </div>
      )}

      {/* Estilos de impresión */}
      <style>{`
        @media print {
          header, aside, .md\\:hidden, [role="dialog"], .i { display: none !important; }
          main { width: 100% !important; }
          section { page-break-inside: avoid; }
          input[type=date], button { filter: grayscale(1); }
        }
      `}</style>
    </div>
  );
}

// ----- Sidebar component MEJORADO -----
function Sidebar({
  sections,
  totals,
  onAddItem,
  onNavigate,
}: {
  sections: Section[];
  totals: { total: number; done: number; pct: number; averageScore: number; inProgress: number; pending: number; criticalItems: number };
  onAddItem: (sectionId: string) => void;
  onNavigate?: () => void;
}) {
  return (
    <nav>
      <div className="rounded-2xl p-4 bg-blue-600 text-white mb-3">
        <div className="text-xs uppercase tracking-wide opacity-90">Progreso General</div>
        <div className="flex items-center gap-3 mt-2">
          <div className="relative h-12 w-12">
            <div
              className="absolute inset-0 rounded-full"
              style={{ background: `conic-gradient(white ${totals.pct * 3.6}deg, rgba(255,255,255,.35) 0deg)` }}
            />
            <div className="absolute inset-1 rounded-full bg-blue-600 grid place-items-center text-sm font-semibold">
              {totals.pct}%
            </div>
          </div>
          <div className="text-sm">
            <div><span className="font-semibold">{totals.done}</span> / {totals.total} completados</div>
            <div className="text-xs opacity-90">Calificación: {totals.averageScore}%</div>
          </div>
        </div>
        
        <div className="mt-3 grid grid-cols-3 gap-2 text-center text-xs">
          <div className="bg-green-500/30 rounded p-1">
            <div className="font-semibold">{totals.done}</div>
            <div>Completados</div>
          </div>
          <div className="bg-yellow-500/30 rounded p-1">
            <div className="font-semibold">{totals.inProgress}</div>
            <div>En proceso</div>
          </div>
          <div className="bg-red-500/30 rounded p-1">
            <div className="font-semibold">{totals.pending}</div>
            <div>Pendientes</div>
          </div>
        </div>
      </div>
      
      <ul>
        {sections.map((s) => (
          <li key={s.id} className="mb-1">
            <a
              href={`#${s.id}`}
              onClick={onNavigate}
              className="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-blue-50"
            >
              <span className="text-sm font-medium text-blue-900">{s.title}</span>
              <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                {s.items.length}
              </span>
            </a>
          </li>
        ))}
      </ul>
      
      <div className="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
        <div className="text-sm font-semibold text-yellow-800">Items Críticos</div>
        <div className="text-2xl font-bold text-yellow-600 mt-1">{totals.criticalItems}</div>
        <div className="text-xs text-yellow-700">Requieren atención inmediata</div>
      </div>

      <div className="mt-3 text-[11px] text-gray-500">
        <p>Consejo: Usa el sistema de evaluación para calificar cada item y hacer seguimiento detallado.</p>
      </div>
    </nav>
  );
}

// Datos iniciales (con maxScore agregado)
const initialSections: Section[] = [
  {
    id: "docs",
    title: "Documentos y Manuales",
    items: [
      { id: "manual-organizacion", label: "Manual de Organización", ref: "Ref. 5.5.1", maxScore: 10 },
      { id: "manual-proc-admin", label: "Manual de Procedimientos Administrativos", ref: "Ref. 5.5.2", maxScore: 10 },
      // ... (agregar maxScore: 10 a todos los items existentes)
    ],
  },
  // ... (todas las demás secciones)
];
